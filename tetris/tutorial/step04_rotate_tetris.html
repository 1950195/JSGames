<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Step 4: Rotate the Tetris</title>
    <style type="text/css">
        ul {list-style: none; display: table-row;}
        li {display: table-cell; height: 20px; width: 20px; border-right: 1px solid #ccc; border-bottom: 1px solid #ccc}
        li.active, li.pile {background-color: green}
        #playground ul:first-child li {border-top: 1px solid #ccc}
        #playground ul li:first-child {border-left: 1px solid #ccc}
    </style>
</head>
<body>
    <header></header>
    <article id="playground"></article>
    <script type="text/javascript" src="../jquery-2.1.4.min.js"></script>
    <script>
        (function(window, document, $, undefined) {
            var TOTAL_ROWS = 20,
                TOTAL_COLS = 10,
                $playground = $('#playground'),
                genPlayground = function() {
                    var strHtml = '',
                        i = 0,
                        j;

                    for (; i < TOTAL_ROWS; i++) {
                        strHtml += '<ul>';

                        for (j = 0; j < TOTAL_COLS; j++) {
                            strHtml += '<li></li>';
                        }

                        strHtml += '</ul>';
                    }

                    $playground.html(strHtml);
                },
                cleanPlayground = function() {
                    $playground.find('.active').removeClass('active');
                },
                // x, y: (0, 0) is (first row, first col)
                Block = function(x, y) {
                    this.x = x;
                    this.y = y;
                    this.drawing = function() {
                        $playground.find('ul:eq(' + this.x + ') li:eq(' + this.y + ')').addClass('active');
                    }
                    this.cleaning = function() {
                        $playground.find('ul:eq(' + this.x + ') li:eq(' + this.y + ')').removeClass('active');
                    };
                },
                // blocks: Array of the block instance
                Tetris = function(shape) {
                    this.blocks = convertShapeToBlocks(shape);
                    this.index = shape.index;
                    this.group = shape.group;
                    this.totalTypes = this.group.length;
                    this.drawing = function() {
                        $.each(this.blocks, function(index, block) {
                            block.drawing();
                        });
                    };
                    this.cleaning = function() {
                        $.each(this.oldBlocks, function(index, block) {
                            block.cleaning();
                        });
                    };
                    this.next = function() {
                        if (this.index + 1 === this.totalTypes) {
                            this.index = 0;
                        } else {
                            this.index++;
                        }
                        this.oldBlocks = this.block;
                        this.block = convertShapeToBlocks(this.group[this.index]);
                        this.cleaning();
                        this.drawing();
                    };
                },
                shapeModels = [
                    [
                        [[0, 4], [0, 5], [1, 4], [1, 5]]
                    ],
                    [
                        [[0, 3], [0, 4], [0, 5], [0, 6]],
                        [[0, 4], [1, 4], [2, 4], [3, 4]]
                    ],
                    [
                        [[0, 4], [1, 4], [1, 5], [2, 5]],
                        [[0, 4], [0, 5], [1, 3], [1, 4]]
                    ],
                    [
                        [[0, 5], [1, 4], [1, 5], [2, 4]],
                        [[0, 3], [0, 4], [1, 4], [1, 5]]
                    ],
                    [
                        [[0, 4], [1, 3], [1, 4], [1, 5]],
                        [[0, 4], [1, 4], [1, 5], [2, 4]],
                        [[0, 3], [0, 4], [0, 5], [1, 4]],
                        [[0, 5], [1, 4], [1, 5], [2, 5]]
                    ],
                    [
                        [[0, 3], [0, 4], [0, 5], [1, 3]],
                        [[0, 4], [0, 5], [1, 5], [2, 5]],
                        [[0, 5], [1, 3], [1, 4], [1, 5]],
                        [[0, 4], [1, 4], [2, 4], [2, 5]]
                    ],
                    [
                        [[0, 3], [0, 4], [0, 5], [1, 5]],
                        [[0, 5], [1, 5], [2, 4], [2, 5]],
                        [[0, 3], [1, 3], [1, 4], [1, 5]],
                        [[0, 4], [0, 5], [1, 4], [2, 4]]
                    ]
                ],
                shapeList = (function(list) {
                    var shape = list.shift();

                    shape = $.map(shape, function(item, index) {
                        return {model: item, index: index, group: shape};
                    });

                    if (list.length === 0) {
                        return shape;
                    } else {
                        return $.merge(shape, arguments.callee(list));
                    }
                })($.extend(true, [], shapeModels)),
                convertShapeToBlocks = function(shape) {
                    return $.map(shape.model, function(item) {
                        return new Block(item[0], item[1]);
                    })
                };

            genPlayground();

            // just to test the active block
            var index = 0;

            setInterval(function() {
                if (shapeList.length === index) {
                    index = 0;
                }

                cleanPlayground();
                new Tetris(shapeList[index++]).drawing();
            }, 1000);

        })(window, document, jQuery);
    </script>
</body>
</html>